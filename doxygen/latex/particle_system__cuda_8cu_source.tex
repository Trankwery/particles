\hypertarget{particle_system__cuda_8cu_source}{\section{particle\-System\-\_\-cuda.\-cu}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright 1993-2012 NVIDIA Corporation.  All rights reserved.}
00003 \textcolor{comment}{ *}
00004 \textcolor{comment}{ * Please refer to the NVIDIA end user license agreement (EULA) associated}
00005 \textcolor{comment}{ * with this source code for terms and conditions that govern your use of}
00006 \textcolor{comment}{ * this software. Any use, reproduction, disclosure, or distribution of}
00007 \textcolor{comment}{ * this software and related documentation outside the terms of the EULA}
00008 \textcolor{comment}{ * is strictly prohibited.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ */}
00011   \textcolor{comment}{/** \(\backslash\)file particleSystem\_cuda.cu}
00012 \textcolor{comment}{  * \(\backslash\)brief Definicje (implementacje) funkcji odpowiedzialnych za przebieg symulacji.}
00013 \textcolor{comment}{  *}
00014 \textcolor{comment}{  */}
00015 
00016 
00017 
00018 \textcolor{comment}{// This file contains C wrappers around the some of the CUDA API and the}
00019 \textcolor{comment}{// kernel functions so that they can be called from "particleSystem.cpp"}
00020 
00021 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_APPLE\_\_}\textcolor{preprocessor}{)} \textcolor{preprocessor}{||} \textcolor{preprocessor}{defined}\textcolor{preprocessor}{(}\textcolor{preprocessor}{MACOSX}\textcolor{preprocessor}{)}
00022 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{GLUT}\textcolor{preprocessor}{/}\textcolor{preprocessor}{glut}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00023 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00024 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{GL}\textcolor{preprocessor}{/}\textcolor{preprocessor}{freeglut}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00025 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00026 
00027 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cstdlib}\textcolor{preprocessor}{>}
00028 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cstdio}\textcolor{preprocessor}{>}
00029 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{string}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00030 
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cuda\_runtime}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cuda\_gl\_interop}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{helper\_cuda}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00035 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{helper\_cuda\_gl}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00036 
00037 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{helper\_functions}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00038 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"thrust/device\_ptr.h"}
00039 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"thrust/for\_each.h"}
00040 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"thrust/iterator/zip\_iterator.h"}
00041 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"thrust/sort.h"}
00042 
00043 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{particles__kernel__impl_8cuh}{"particles\_kernel\_impl.cuh"}                               \textcolor{comment}{//w tym
       pliku sa impementacje obliczen}
00044 
00045 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"}
00046 \{
00047 
\hypertarget{particle_system__cuda_8cu_source_l00048}{}\hyperlink{particle_system__cuda_8cu_ad205012a960928f6fb61ea4f51a95e9f}{00048}     \textcolor{keywordtype}{void} cudaInit(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv)
00049     \{
00050         \textcolor{keywordtype}{int} devID;
00051 
00052         \textcolor{comment}{// use command-line specified CUDA device, otherwise use device with highest Gflops/s}
00053         devID = findCudaDevice(argc, (\textcolor{keyword}{const} \textcolor{keywordtype}{char} **)argv);
00054 
00055         \textcolor{keywordflow}{if} (devID < 0)
00056         \{
00057             printf(\textcolor{stringliteral}{"No CUDA Capable devices found, exiting...\(\backslash\)n"});
00058             exit(EXIT\_SUCCESS);
00059         \}
00060     \}
00061 
\hypertarget{particle_system__cuda_8cu_source_l00062}{}\hyperlink{particle_system__cuda_8cu_a4e20ffdf94c8d60a5c32ecde149c8554}{00062}     \textcolor{keywordtype}{void} cudaGLInit(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv)
00063     \{
00064         \textcolor{comment}{// use command-line specified CUDA device, otherwise use device with highest Gflops/s}
00065         findCudaGLDevice(argc, (\textcolor{keyword}{const} \textcolor{keywordtype}{char} **)argv);
00066     \}
00067 
\hypertarget{particle_system__cuda_8cu_source_l00068}{}\hyperlink{particle_system__cuda_8cu_a781553d31085a23b6d0be9d19982759a}{00068}     \textcolor{keywordtype}{void} allocateArray(\textcolor{keywordtype}{void} **devPtr, size\_t size)
00069     \{
00070         checkCudaErrors(cudaMalloc(devPtr, size));
00071     \}
00072 
\hypertarget{particle_system__cuda_8cu_source_l00073}{}\hyperlink{particle_system__cuda_8cu_a2946519c8d9c4f8ebf552bf044821ea9}{00073}     \textcolor{keywordtype}{void} freeArray(\textcolor{keywordtype}{void} *devPtr)
00074     \{
00075         checkCudaErrors(cudaFree(devPtr));
00076     \}
00077 
\hypertarget{particle_system__cuda_8cu_source_l00078}{}\hyperlink{particle_system__cuda_8cu_af59f4c114812beed29874c0a1a31519d}{00078}     \textcolor{keywordtype}{void} threadSync()
00079     \{
00080         checkCudaErrors(cudaDeviceSynchronize());
00081     \}
00082 
\hypertarget{particle_system__cuda_8cu_source_l00083}{}\hyperlink{particle_system__cuda_8cu_ac4d4ecd921dbed6c2deef639ca295374}{00083}     \textcolor{keywordtype}{void} copyArrayToDevice(\textcolor{keywordtype}{void} *device, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *host, \textcolor{keywordtype}{int} offset, \textcolor{keywordtype}{int} size)
00084     \{
00085         checkCudaErrors(cudaMemcpy((\textcolor{keywordtype}{char} *) device + offset, host, size, cudaMemcpyHostToDevice));
00086     \}
00087 
\hypertarget{particle_system__cuda_8cu_source_l00088}{}\hyperlink{particle_system__cuda_8cu_a4386a84282ceeaba09939817aa2a9c24}{00088}     \textcolor{keywordtype}{void} registerGLBufferObject(uint vbo, \textcolor{keyword}{struct} cudaGraphicsResource **cuda\_vbo\_resource)
00089     \{
00090         checkCudaErrors(cudaGraphicsGLRegisterBuffer(cuda\_vbo\_resource, vbo,
00091                                                      cudaGraphicsMapFlagsNone));
00092     \}
00093 
\hypertarget{particle_system__cuda_8cu_source_l00094}{}\hyperlink{particle_system__cuda_8cu_a9afef8c00ca779aae2d7484b45bce34c}{00094}     \textcolor{keywordtype}{void} unregisterGLBufferObject(\textcolor{keyword}{struct} cudaGraphicsResource *cuda\_vbo\_resource)
00095     \{
00096         checkCudaErrors(cudaGraphicsUnregisterResource(cuda\_vbo\_resource));
00097     \}
00098 
\hypertarget{particle_system__cuda_8cu_source_l00099}{}\hyperlink{particle_system__cuda_8cu_aa491077afd740a269815eb9ce81c8642}{00099}     \textcolor{keywordtype}{void} *mapGLBufferObject(\textcolor{keyword}{struct} cudaGraphicsResource **cuda\_vbo\_resource)
00100     \{
00101         \textcolor{keywordtype}{void} *ptr;
00102         checkCudaErrors(cudaGraphicsMapResources(1, cuda\_vbo\_resource, 0));
00103         size\_t num\_bytes;
00104         checkCudaErrors(cudaGraphicsResourceGetMappedPointer((\textcolor{keywordtype}{void} **)&ptr, &num\_bytes,
00105                                                              *cuda\_vbo\_resource));
00106         \textcolor{keywordflow}{return} ptr;
00107     \}
00108 
\hypertarget{particle_system__cuda_8cu_source_l00109}{}\hyperlink{particle_system__cuda_8cu_a98c3325419b7528d34a51ca7972d7095}{00109}     \textcolor{keywordtype}{void} unmapGLBufferObject(\textcolor{keyword}{struct} cudaGraphicsResource *cuda\_vbo\_resource)
00110     \{
00111         checkCudaErrors(cudaGraphicsUnmapResources(1, &cuda\_vbo\_resource, 0));
00112     \}
00113 
\hypertarget{particle_system__cuda_8cu_source_l00114}{}\hyperlink{particle_system__cuda_8cu_a54716407dbd516db34f42b2faf7f91a3}{00114}     \textcolor{keywordtype}{void} copyArrayFromDevice(\textcolor{keywordtype}{void} *host, \textcolor{keyword}{const} \textcolor{keywordtype}{void} *device,
00115                              \textcolor{keyword}{struct} cudaGraphicsResource **cuda\_vbo\_resource, \textcolor{keywordtype}{int} size)
00116     \{
00117         \textcolor{keywordflow}{if} (cuda\_vbo\_resource)
00118         \{
00119             device = mapGLBufferObject(cuda\_vbo\_resource);
00120         \}
00121 
00122         checkCudaErrors(cudaMemcpy(host, device, size, cudaMemcpyDeviceToHost));
00123 
00124         \textcolor{keywordflow}{if} (cuda\_vbo\_resource)
00125         \{
00126             unmapGLBufferObject(*cuda\_vbo\_resource);
00127         \}
00128     \}
00129 
\hypertarget{particle_system__cuda_8cu_source_l00130}{}\hyperlink{particle_system__cuda_8cu_a342176dbaba2668312c45e1a1423fc4e}{00130}     \textcolor{keywordtype}{void} setParameters(SimParams *hostParams)
00131     \{
00132         \textcolor{comment}{// copy parameters to constant memory}
00133         checkCudaErrors(cudaMemcpyToSymbol(params, hostParams, \textcolor{keyword}{sizeof}(SimParams)));
00134     \}
00135 
00136     \textcolor{comment}{//Round a / b to nearest higher integer value}
\hypertarget{particle_system__cuda_8cu_source_l00137}{}\hyperlink{particle_system__cuda_8cu_aa5accec7fb28381615c8cb68522c9eb3}{00137}     uint iDivUp(uint a, uint b)
00138     \{
00139         \textcolor{keywordflow}{return} (a % b != 0) ? (a / b + 1) : (a / b);
00140     \}
00141 
00142     \textcolor{comment}{// compute grid and thread block size for a given number of elements}
\hypertarget{particle_system__cuda_8cu_source_l00143}{}\hyperlink{particle_system__cuda_8cu_a78e8aa50e0629b57cff219a2fa753ed0}{00143}     \textcolor{keywordtype}{void} computeGridSize(uint n, uint blockSize, uint &numBlocks, uint &numThreads)
00144     \{
00145         numThreads = min(blockSize, n);
00146         numBlocks = iDivUp(n, numThreads);
00147     \}
00148 
\hypertarget{particle_system__cuda_8cu_source_l00149}{}\hyperlink{particle_system__cuda_8cu_a34e9db8b801cd537e5ae5a4a886e020c}{00149}     \textcolor{keywordtype}{void} integrateSystem(\textcolor{keywordtype}{float} *pos,
00150                          \textcolor{keywordtype}{float} *vel,
00151                          \textcolor{keywordtype}{float} deltaTime,
00152                          uint numParticles)
00153     \{
00154         thrust::device\_ptr<float4> d\_pos4((float4 *)pos);
00155         thrust::device\_ptr<float4> d\_vel4((float4 *)vel);
00156 
00157         thrust::for\_each(
00158             thrust::make\_zip\_iterator(thrust::make\_tuple(d\_pos4, d\_vel4)),
00159             thrust::make\_zip\_iterator(thrust::make\_tuple(d\_pos4+numParticles, d\_vel4+numParticles)),
00160             integrate\_functor(deltaTime));
00161     \}
00162 
\hypertarget{particle_system__cuda_8cu_source_l00163}{}\hyperlink{particle_system__cuda_8cu_ae0a4037d25e768622443077546399cf2}{00163}     \textcolor{keywordtype}{void} calcHash(uint  *gridParticleHash,
00164                   uint  *gridParticleIndex,
00165                   \textcolor{keywordtype}{float} *pos,
00166                   \textcolor{keywordtype}{int}    numParticles)
00167     \{
00168         uint numThreads, numBlocks;
00169         computeGridSize(numParticles, 256, numBlocks, numThreads);
00170 
00171 \textcolor{comment}{///////////////////////////////////////////////////////////////////////////}
00172 \textcolor{comment}{/*      wywolanie watkow        */}
00173 \textcolor{comment}{///////////////////////////////////////////////////////////////////////////}
00174         \textcolor{comment}{// execute the kernel}
00175         calcHashD<<< numBlocks, numThreads >>>(gridParticleHash,
00176                                                gridParticleIndex,
00177                                                (float4 *) pos,
00178                                                numParticles);
00179 
00180         \textcolor{comment}{// check if kernel invocation generated an error}
00181         getLastCudaError(\textcolor{stringliteral}{"Kernel execution failed"});
00182     \}
00183 
\hypertarget{particle_system__cuda_8cu_source_l00184}{}\hyperlink{particle_system__cuda_8cu_ac72ccd068434c46c2f901c751d53be1d}{00184}     \textcolor{keywordtype}{void} reorderDataAndFindCellStart(uint  *cellStart,
00185                                      uint  *cellEnd,
00186                                      \textcolor{keywordtype}{float} *sortedPos,
00187                                      \textcolor{keywordtype}{float} *sortedVel,
00188                                      uint  *gridParticleHash,
00189                                      uint  *gridParticleIndex,
00190                                      \textcolor{keywordtype}{float} *oldPos,
00191                                      \textcolor{keywordtype}{float} *oldVel,
00192                                      uint   numParticles,
00193                                      uint   numCells)
00194     \{
00195         uint numThreads, numBlocks;
00196         computeGridSize(numParticles, 256, numBlocks, numThreads);
00197 
00198         \textcolor{comment}{// set all cells to empty}
00199         checkCudaErrors(cudaMemset(cellStart, 0xffffffff, numCells*\textcolor{keyword}{sizeof}(uint)));
00200 
00201 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{particles__kernel_8cuh_a0ab211ca35e2616c721fcf2dd4f99c83}{USE\_TEX}
00202         checkCudaErrors(cudaBindTexture(0, oldPosTex, oldPos, numParticles*\textcolor{keyword}{sizeof}(float4)));
00203         checkCudaErrors(cudaBindTexture(0, oldVelTex, oldVel, numParticles*\textcolor{keyword}{sizeof}(float4)));
00204 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00205 
00206         uint smemSize = \textcolor{keyword}{sizeof}(uint)*(numThreads+1);
00207         reorderDataAndFindCellStartD<<< numBlocks, numThreads, smemSize>>>(
00208             cellStart,
00209             cellEnd,
00210             (float4 *) sortedPos,
00211             (float4 *) sortedVel,
00212             gridParticleHash,
00213             gridParticleIndex,
00214             (float4 *) oldPos,
00215             (float4 *) oldVel,
00216             numParticles);
00217         getLastCudaError(\textcolor{stringliteral}{"Kernel execution failed: reorderDataAndFindCellStartD"});
00218 
00219 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{particles__kernel_8cuh_a0ab211ca35e2616c721fcf2dd4f99c83}{USE\_TEX}
00220         checkCudaErrors(cudaUnbindTexture(oldPosTex));
00221         checkCudaErrors(cudaUnbindTexture(oldVelTex));
00222 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00223     \}
00224 
\hypertarget{particle_system__cuda_8cu_source_l00225}{}\hyperlink{particle_system__cuda_8cu_ad9d704d76ddff93e75ca7d39f57bbced}{00225}     \textcolor{keywordtype}{void} collide(\textcolor{keywordtype}{float} *newVel,
00226                  \textcolor{keywordtype}{float} *sortedPos,
00227                  \textcolor{keywordtype}{float} *sortedVel,
00228                  uint  *gridParticleIndex,
00229                  uint  *cellStart,
00230                  uint  *cellEnd,
00231                  uint   numParticles,
00232                  uint   numCells,
00233                                  \textcolor{keywordtype}{float} deltaTime)
00234     \{
00235 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{particles__kernel_8cuh_a0ab211ca35e2616c721fcf2dd4f99c83}{USE\_TEX}
00236         checkCudaErrors(cudaBindTexture(0, oldPosTex, sortedPos, numParticles*\textcolor{keyword}{sizeof}(float4)));
00237         checkCudaErrors(cudaBindTexture(0, oldVelTex, sortedVel, numParticles*\textcolor{keyword}{sizeof}(float4)));
00238         checkCudaErrors(cudaBindTexture(0, cellStartTex, cellStart, numCells*\textcolor{keyword}{sizeof}(uint)));
00239         checkCudaErrors(cudaBindTexture(0, cellEndTex, cellEnd, numCells*\textcolor{keyword}{sizeof}(uint)));
00240 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00241 
00242         \textcolor{comment}{// thread per particle}
00243         uint numThreads, numBlocks;
00244         computeGridSize(numParticles, 64, numBlocks, numThreads);
00245 
00246 \textcolor{comment}{///////////////////////////////////////////////////////////////////////////}
00247 \textcolor{comment}{/*      wywolanie watkow zderzen        */}
00248 \textcolor{comment}{///////////////////////////////////////////////////////////////////////////}
00249         \textcolor{comment}{// execute the kernel}
00250         collideD<<< numBlocks, numThreads >>>((float4 *)newVel,
00251                                               (float4 *)sortedPos,
00252                                               (float4 *)sortedVel,
00253                                               gridParticleIndex,
00254                                               cellStart,
00255                                               cellEnd,
00256                                               numParticles,
00257                                                                                           deltaTime);
00258 
00259         \textcolor{comment}{// check if kernel invocation generated an error}
00260         getLastCudaError(\textcolor{stringliteral}{"Kernel execution failed"});
00261 
00262 \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \hyperlink{particles__kernel_8cuh_a0ab211ca35e2616c721fcf2dd4f99c83}{USE\_TEX}
00263         checkCudaErrors(cudaUnbindTexture(oldPosTex));
00264         checkCudaErrors(cudaUnbindTexture(oldVelTex));
00265         checkCudaErrors(cudaUnbindTexture(cellStartTex));
00266         checkCudaErrors(cudaUnbindTexture(cellEndTex));
00267 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00268     \}
00269 
00270 
\hypertarget{particle_system__cuda_8cu_source_l00271}{}\hyperlink{particle_system__cuda_8cu_ac71da7e4672a2732a098ba933a799257}{00271}     \textcolor{keywordtype}{void} sortParticles(uint *dGridParticleHash, uint *dGridParticleIndex, uint numParticles)
00272     \{
00273         thrust::sort\_by\_key(thrust::device\_ptr<uint>(dGridParticleHash),
00274                             thrust::device\_ptr<uint>(dGridParticleHash + numParticles),
00275                             thrust::device\_ptr<uint>(dGridParticleIndex));
00276     \}
00277 
00278 \}   \textcolor{comment}{// extern "C"}
\end{DoxyCode}
