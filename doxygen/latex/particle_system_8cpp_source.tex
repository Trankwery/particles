\hypertarget{particle_system_8cpp_source}{\section{particle\-System.\-cpp}
}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright 1993-2012 NVIDIA Corporation.  All rights reserved.}
00003 \textcolor{comment}{ *}
00004 \textcolor{comment}{ * Please refer to the NVIDIA end user license agreement (EULA) associated}
00005 \textcolor{comment}{ * with this source code for terms and conditions that govern your use of}
00006 \textcolor{comment}{ * this software. Any use, reproduction, disclosure, or distribution of}
00007 \textcolor{comment}{ * this software and related documentation outside the terms of the EULA}
00008 \textcolor{comment}{ * is strictly prohibited.}
00009 \textcolor{comment}{ *}
00010 \textcolor{comment}{ */}
00011  \textcolor{comment}{/** \(\backslash\)file particleSystem.cpp}
00012 \textcolor{comment}{  * \(\backslash\)brief Definicje (implementacje) metod klasy ParticleSystem}
00013 \textcolor{comment}{  * oraz funkcji pomocniczych}
00014 \textcolor{comment}{  */}
00015 
00016 
00017 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{particle_system_8h}{"particleSystem.h"}
00018 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{particle_system_8cuh}{"particleSystem.cuh"}
00019 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{particles__kernel_8cuh}{"particles\_kernel.cuh"}
00020 
00021 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cuda\_runtime}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00022 
00023 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{helper\_functions}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00024 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{helper\_cuda}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00025 
00026 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{assert}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00027 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{math}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00028 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{memory}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00029 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cstdio}\textcolor{preprocessor}{>}
00030 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{cstdlib}\textcolor{preprocessor}{>}
00031 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{algorithm}\textcolor{preprocessor}{>}
00032 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{GL}\textcolor{preprocessor}{/}\textcolor{preprocessor}{glew}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00033 
00034 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{CUDART\_PI\_F}
\hypertarget{particle_system_8cpp_source_l00035}{}\hyperlink{particle_system_8cpp_a0af3123952dff68caffd7e1357abe1b7}{00035} \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{CUDART\_PI\_F}         3.141592654f
00036 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00037 
00038 \textcolor{keyword}{extern} \textcolor{keywordtype}{bool} \hyperlink{particle_system_8cpp_a54f61e4f37db321d451436bf2201b8cb}{multiColor};
00039 
\hypertarget{particle_system_8cpp_source_l00040}{}\hyperlink{class_particle_system_a8a2be3e93616aa694801369c8b8d12cb}{00040} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a8a2be3e93616aa694801369c8b8d12cb}{ParticleSystem}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} numParticles, uint3 gridSize,
       \textcolor{keywordtype}{bool} bUseOpenGL) :
00041     \hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized}(\textcolor{keyword}{false}),
00042     \hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL}(bUseOpenGL),
00043     \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}(numParticles),
00044     \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}(0),
00045     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}(0),
00046     \hyperlink{class_particle_system_afff6217d2726217dff77c81ef3c23bfa}{m\_dPos}(0),
00047     \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}(0),
00048     \hyperlink{class_particle_system_a8a2be3e93616aa694801369c8b8d12cb}{m\_gridSize}(\hyperlink{class_particle_system_a8a2be3e93616aa694801369c8b8d12cb}{gridSize}),
00049     \hyperlink{class_particle_system_a8a2be3e93616aa694801369c8b8d12cb}{m\_timer}(NULL),
00050     \hyperlink{class_particle_system_a7b4b053433c052518b8ecce1b02000f5}{m\_solverIterations}(1)
00051 \{
00052     m\_numGridCells = m\_gridSize.x*m\_gridSize.y*m\_gridSize.z;
00053     float3 worldSize = make\_float3(2.0f, 2.0f, 2.0f);
00054 
00055     \hyperlink{class_particle_system_a2a0452a32993337176d88fa2fbe63020}{m\_gridSortBits} = 18;    \textcolor{comment}{// increase this for larger grids}
00056 
00057     \textcolor{comment}{// set simulation parameters}
00058     m\_params.gridSize = m\_gridSize;
00059     m\_params.numCells = m\_numGridCells;
00060     m\_params.numBodies = m\_numParticles;
00061 
00062         \textcolor{comment}{/**}
00063 \textcolor{comment}{        * promie√± w mikronach}
00064 \textcolor{comment}{        */}
00065     m\_params.particleRadius = 0.225f;\textcolor{comment}{//1.0f / 32.0f;//32.0f / 64.0f;}
00066     m\_params.colliderPos = make\_float3(-1.2f, -0.8f, 0.8f);
00067     m\_params.colliderRadius = 0.2f;
00068 
00069         m\_params.particleMass=1.0f;
00070 
00071     m\_params.worldOrigin = make\_float3(-1.0f, -1.0f, -1.0f);
00072     \textcolor{comment}{//    m\_params.cellSize = make\_float3(worldSize.x / m\_gridSize.x, worldSize.y / m\_gridSize.y,
       worldSize.z / m\_gridSize.z);}
00073     \textcolor{keywordtype}{float} cellSize = m\_params.particleRadius * 3.0f;  \textcolor{comment}{// cell size equal to particle diameter}
00074     m\_params.cellSize = make\_float3(cellSize, cellSize, cellSize);
00075 
00076     m\_params.spring = 0.5f;
00077     m\_params.damping = 0.1f;
00078     m\_params.shear = 0.1f;
00079     m\_params.attraction = 0.1f;
00080     m\_params.boundaryDamping = -1.0f;
00081 
00082     m\_params.gravity = make\_float3(0.0f, -0.0003f, 0.0f);
00083     m\_params.globalDamping = 1.0f;
00084 
00085         m\_params.bigradius=10.0f;\textcolor{comment}{//docelowo zmieny rozmiar zewnetrznej kuli}
00086         m\_params.bigradius0=10.0f;
00087         m\_params.boundaries=\textcolor{keyword}{true};
00088         m\_params.epsi=0.1f;
00089         m\_params.brown=0.00001f;
00090         m\_params.brownQuality=10;
00091 
00092         m\_params.particleTypesNum=1;
00093 
00094     \hyperlink{class_particle_system_a484988642e046424d32a13709204e8de}{\_initialize}\hyperlink{class_particle_system_a484988642e046424d32a13709204e8de}{(}numParticles\hyperlink{class_particle_system_a484988642e046424d32a13709204e8de}{)};
00095 \}
00096 
\hypertarget{particle_system_8cpp_source_l00097}{}\hyperlink{class_particle_system_a6bc725349a763b9d6817950cde16a93f}{00097} \hyperlink{class_particle_system}{ParticleSystem}::~\hyperlink{class_particle_system_a6bc725349a763b9d6817950cde16a93f}{ParticleSystem}()
00098 \{
00099     \hyperlink{class_particle_system_a5d6a52db7d1277c8fe734ecceb69e5c6}{\_finalize}\hyperlink{class_particle_system_a5d6a52db7d1277c8fe734ecceb69e5c6}{(}\hyperlink{class_particle_system_a5d6a52db7d1277c8fe734ecceb69e5c6}{)};
00100     \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles} = 0;
00101 \}
00102 
00103 \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}
\hypertarget{particle_system_8cpp_source_l00104}{}\hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{00104} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{createVBO}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} size)
00105 \{
00106     GLuint vbo;
00107     glGenBuffers(1, &vbo);
00108     glBindBuffer(GL\_ARRAY\_BUFFER, vbo);
00109     glBufferData(GL\_ARRAY\_BUFFER, size, 0, GL\_DYNAMIC\_DRAW);
00110     glBindBuffer(GL\_ARRAY\_BUFFER, 0);
00111     \textcolor{keywordflow}{return} vbo;
00112 \}
00113 
\hypertarget{particle_system_8cpp_source_l00114}{}\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{00114} \textcolor{keyword}{inline} \textcolor{keywordtype}{float} \hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{lerp}(\textcolor{keywordtype}{float} a, \textcolor{keywordtype}{float} b, \textcolor{keywordtype}{float} t)
00115 \{
00116     \textcolor{keywordflow}{return} a + t*(b-a);
00117 \}
00118 
00119 \textcolor{comment}{// create a color ramp}
\hypertarget{particle_system_8cpp_source_l00120}{}\hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{00120} \textcolor{keywordtype}{void} \hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{colorRamp}(\textcolor{keywordtype}{float} t, \textcolor{keywordtype}{float} *r)
00121 \{
00122     \textcolor{keyword}{const} \textcolor{keywordtype}{int} ncolors = 7;
00123     \textcolor{keywordtype}{float} c[ncolors][3] =
00124     \{
00125         \{ 1.0, 0.0, 0.0, \},
00126         \{ 1.0, 0.5, 0.0, \},
00127         \{ 1.0, 1.0, 0.0, \},
00128         \{ 0.0, 1.0, 0.0, \},
00129         \{ 0.0, 1.0, 1.0, \},
00130         \{ 0.0, 0.0, 1.0, \},
00131         \{ 1.0, 0.0, 1.0, \},
00132     \};
00133     t = t * (ncolors-1);
00134     \textcolor{keywordtype}{int} i = (\textcolor{keywordtype}{int}) t;
00135     \textcolor{keywordtype}{float} u = t - floor(t);
00136     r[0] = \hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{lerp}\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{(}c[i][0]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} c[i+1][0]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} u\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{)};
00137     r[1] = \hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{lerp}\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{(}c[i][1]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} c[i+1][1]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} u\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{)};
00138     r[2] = \hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{lerp}\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{(}c[i][2]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} c[i+1][2]\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{,} u\hyperlink{particle_system_8cpp_aaece5bea3dfe5043f19232f3e6e1e575}{)};
00139 \}
00140 
00141 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00142}{}\hyperlink{class_particle_system_a484988642e046424d32a13709204e8de}{00142} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a484988642e046424d32a13709204e8de}{\_initialize}(\textcolor{keywordtype}{int} numParticles)
00143 \{
00144     assert(!\hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized});
00145 
00146     \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles} = numParticles;
00147 
00148     \textcolor{comment}{// allocate host storage}
00149     \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos} = \textcolor{keyword}{new} \textcolor{keywordtype}{float}[\hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4];
00150     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel} = \textcolor{keyword}{new} \textcolor{keywordtype}{float}[\hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4];
00151 
00152     memset(\hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}, 0, \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));
00153     memset(\hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}, 0, \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}));
00154 
00155     \hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart} = \textcolor{keyword}{new} \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}[\hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}];
00156     memset(\hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart}, 0, \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}*\textcolor{keyword}{sizeof}(
      \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}));
00157 
00158     \hyperlink{class_particle_system_a8d8ad2d142f3a5b83f2c10a46f5d7a8b}{m\_hCellEnd} = \textcolor{keyword}{new} \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}[\hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}];
00159     memset(\hyperlink{class_particle_system_a8d8ad2d142f3a5b83f2c10a46f5d7a8b}{m\_hCellEnd}, 0, \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}*\textcolor{keyword}{sizeof}(
      \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}));
00160 
00161     \textcolor{comment}{// allocate GPU data}
00162     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} memSize = \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}) * 4 * \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles};
00163 
00164     \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00165     \{
00166         \hyperlink{class_particle_system_a31f9cccdf5dbae6f72867665bd8761e3}{m\_posVbo} = \hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{createVBO}\hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{(}memSize\hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{)};
00167         \hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{registerGLBufferObject}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{(}\hyperlink{class_particle_system_a31f9cccdf5dbae6f72867665bd8761e3}{m\_posVbo}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{,} &
      \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{)};
00168     \}
00169     \textcolor{keywordflow}{else}
00170     \{
00171         checkCudaErrors(cudaMalloc((\textcolor{keywordtype}{void} **)&m\_cudaPosVBO, memSize)) ;
00172     \}
00173 
00174     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} memSize\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00175 
00176     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_ab60e8b5a312b2f400b10dfba5153fc3c}{m\_dSortedPos}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} memSize
      \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00177     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_a69122523117954fb5defb8b38e0f46f3}{m\_dSortedVel}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} memSize
      \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00178 
00179     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_ab44080655971a5501eaee6ad7355a139}{m\_dGridParticleHash}
      \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*\textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00180     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}
      \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*\textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00181 
00182     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_a137909a8b34f7a42e50cd0fcc86bb784}{m\_dCellStart}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} 
      \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}*\textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00183     \hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{allocateArray}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{(}(\textcolor{keywordtype}{void} **)&\hyperlink{class_particle_system_a3a0b9c760c2bfcf811d54b8194ebea01}{m\_dCellEnd}\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{,} 
      \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}*\textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})\hyperlink{particle_system_8cuh_aee51e01a5233e0fda578bd5b3bc38e8f}{)};
00184 
00185     \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00186     \{
00187         \hyperlink{class_particle_system_a96b05c719006c9e3eaed759f54a49c7f}{m\_colorVBO} = \hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{createVBO}\hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{(}\hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})
      \hyperlink{class_particle_system_a399eb5cb9c422fd3370899e4d8a5d62e}{)};
00188         \hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{registerGLBufferObject}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{(}\hyperlink{class_particle_system_a96b05c719006c9e3eaed759f54a49c7f}{m\_colorVBO}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{,} &
      \hyperlink{class_particle_system_a140043869727535abc08609b835b98fc}{m\_cuda\_colorvbo\_resource}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{)};
00189 
00190         \textcolor{comment}{// fill color buffer}
00191         glBindBufferARB(GL\_ARRAY\_BUFFER, m\_colorVBO);
00192         \textcolor{keywordtype}{float} *data = (\textcolor{keywordtype}{float} *) glMapBufferARB(GL\_ARRAY\_BUFFER, GL\_WRITE\_ONLY);
00193         \textcolor{keywordtype}{float} *ptr = data;
00194 
00195         \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} i=0; i<\hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}; i++)
00196         \{
00197             \textcolor{keywordtype}{float} t = i / (\textcolor{keywordtype}{float}) \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles};
00198                         \textcolor{keywordflow}{if}(\hyperlink{particle_system_8cpp_a54f61e4f37db321d451436bf2201b8cb}{multiColor})
00199                         \{
00200 #\textcolor{keywordflow}{if} 0
00201             *ptr++ = rand() / (\textcolor{keywordtype}{float}) RAND\_MAX;
00202             *ptr++ = rand() / (\textcolor{keywordtype}{float}) RAND\_MAX;
00203             *ptr++ = rand() / (\textcolor{keywordtype}{float}) RAND\_MAX;
00204 #\textcolor{keywordflow}{else}
00205             \hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{colorRamp}\hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{(}t\hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{,} ptr\hyperlink{particle_system_8cpp_a1ec1ae39a0b30ca8330f7839a624f302}{)};
00206             ptr+=3;
00207 #endif
00208                         \}
00209                         \textcolor{keywordflow}{else}
00210                         \{
00211                                 *ptr++ = 0;
00212                                 *ptr++ = 1;
00213                                 *ptr++ = 0;
00214                         \}
00215             *ptr++ = 1.0f;
00216         \}
00217 
00218         glUnmapBufferARB(GL\_ARRAY\_BUFFER);
00219     \}
00220     \textcolor{keywordflow}{else}
00221     \{
00222         checkCudaErrors(cudaMalloc((\textcolor{keywordtype}{void} **)&m\_cudaColorVBO, \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})*numParticles*4));
00223     \}
00224 
00225     sdkCreateTimer(&m\_timer);
00226 
00227     setParameters(&m\_params);
00228 
00229     \hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized} = \textcolor{keyword}{true};
00230 \}
00231 
00232 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00233}{}\hyperlink{class_particle_system_a5d6a52db7d1277c8fe734ecceb69e5c6}{00233} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a5d6a52db7d1277c8fe734ecceb69e5c6}{\_finalize}()
00234 \{
00235     assert(\hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized});
00236 
00237     \textcolor{keyword}{delete} [] \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos};
00238     \textcolor{keyword}{delete} [] \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel};
00239     \textcolor{keyword}{delete} [] \hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart};
00240     \textcolor{keyword}{delete} [] \hyperlink{class_particle_system_a8d8ad2d142f3a5b83f2c10a46f5d7a8b}{m\_hCellEnd};
00241 
00242     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00243     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_ab60e8b5a312b2f400b10dfba5153fc3c}{m\_dSortedPos}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00244     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_a69122523117954fb5defb8b38e0f46f3}{m\_dSortedVel}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00245 
00246     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_ab44080655971a5501eaee6ad7355a139}{m\_dGridParticleHash}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00247     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00248     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_a137909a8b34f7a42e50cd0fcc86bb784}{m\_dCellStart}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00249     \hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{freeArray}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{(}\hyperlink{class_particle_system_a3a0b9c760c2bfcf811d54b8194ebea01}{m\_dCellEnd}\hyperlink{particle_system_8cuh_a2946519c8d9c4f8ebf552bf044821ea9}{)};
00250 
00251     \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00252     \{
00253         \hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{unregisterGLBufferObject}\hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{(}
      \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{)};
00254         glDeleteBuffers(1, (\textcolor{keyword}{const} GLuint *)&m\_posVbo);
00255         glDeleteBuffers(1, (\textcolor{keyword}{const} GLuint *)&m\_colorVBO);
00256     \}
00257     \textcolor{keywordflow}{else}
00258     \{
00259         checkCudaErrors(cudaFree(m\_cudaPosVBO));
00260         checkCudaErrors(cudaFree(m\_cudaColorVBO));
00261     \}
00262 \}
00263 
00264 \textcolor{comment}{// step the simulation}
00265 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00266}{}\hyperlink{class_particle_system_a166fd86f020b6024d7d42723762d7cb2}{00266} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a166fd86f020b6024d7d42723762d7cb2}{update}(\textcolor{keywordtype}{float} deltaTime)
00267 \{
00268     assert(\hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized});
00269 
00270     \textcolor{keywordtype}{float} *dPos;
00271 
00272     \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00273     \{
00274         dPos = (\textcolor{keywordtype}{float} *) \hyperlink{particle_system_8cuh_aa491077afd740a269815eb9ce81c8642}{mapGLBufferObject}\hyperlink{particle_system_8cuh_aa491077afd740a269815eb9ce81c8642}{(}&
      \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_aa491077afd740a269815eb9ce81c8642}{)};
00275     \}
00276     \textcolor{keywordflow}{else}
00277     \{
00278         dPos = (\textcolor{keywordtype}{float} *) \hyperlink{class_particle_system_aba18245745f621d90186862f1a559d9e}{m\_cudaPosVBO};
00279     \}
00280 
00281     \textcolor{comment}{// update constants}
00282     setParameters(&m\_params);
00283 
00284     \textcolor{comment}{// integrate}
00285     \hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{integrateSystem}\hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{(}
00286         dPos\hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{,}
00287         \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{,}
00288         deltaTime\hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{,}
00289         \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}\hyperlink{particle_system_8cuh_a34e9db8b801cd537e5ae5a4a886e020c}{)};
00290 
00291     \textcolor{comment}{// calculate grid hash}
00292     \hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{calcHash}\hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{(}
00293         \hyperlink{class_particle_system_ab44080655971a5501eaee6ad7355a139}{m\_dGridParticleHash}\hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{,}
00294         \hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}\hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{,}
00295         dPos\hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{,}
00296         \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}\hyperlink{particle_system_8cuh_ae0a4037d25e768622443077546399cf2}{)};
00297 
00298     \textcolor{comment}{// sort particles based on hash}
00299     \hyperlink{particle_system_8cuh_ac71da7e4672a2732a098ba933a799257}{sortParticles}\hyperlink{particle_system_8cuh_ac71da7e4672a2732a098ba933a799257}{(}\hyperlink{class_particle_system_ab44080655971a5501eaee6ad7355a139}{m\_dGridParticleHash}\hyperlink{particle_system_8cuh_ac71da7e4672a2732a098ba933a799257}{,} 
      \hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}\hyperlink{particle_system_8cuh_ac71da7e4672a2732a098ba933a799257}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}\hyperlink{particle_system_8cuh_ac71da7e4672a2732a098ba933a799257}{)};
00300 
00301     \textcolor{comment}{// reorder particle arrays into sorted order and}
00302     \textcolor{comment}{// find start and end of each cell}
00303     \hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{reorderDataAndFindCellStart}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{(}
00304         \hyperlink{class_particle_system_a137909a8b34f7a42e50cd0fcc86bb784}{m\_dCellStart}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00305         \hyperlink{class_particle_system_a3a0b9c760c2bfcf811d54b8194ebea01}{m\_dCellEnd}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00306         \hyperlink{class_particle_system_ab60e8b5a312b2f400b10dfba5153fc3c}{m\_dSortedPos}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00307         \hyperlink{class_particle_system_a69122523117954fb5defb8b38e0f46f3}{m\_dSortedVel}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00308         \hyperlink{class_particle_system_ab44080655971a5501eaee6ad7355a139}{m\_dGridParticleHash}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00309         \hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00310         dPos\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00311         \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00312         \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{,}
00313         \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}\hyperlink{particle_system_8cuh_ac72ccd068434c46c2f901c751d53be1d}{)};
00314 
00315     \textcolor{comment}{// process collisions}
00316     \hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{collide}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{(}
00317         \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00318         \hyperlink{class_particle_system_ab60e8b5a312b2f400b10dfba5153fc3c}{m\_dSortedPos}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00319         \hyperlink{class_particle_system_a69122523117954fb5defb8b38e0f46f3}{m\_dSortedVel}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00320         \hyperlink{class_particle_system_a1a67fc1e3ffd4e64f55a2a315c49c74c}{m\_dGridParticleIndex}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00321         \hyperlink{class_particle_system_a137909a8b34f7a42e50cd0fcc86bb784}{m\_dCellStart}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00322         \hyperlink{class_particle_system_a3a0b9c760c2bfcf811d54b8194ebea01}{m\_dCellEnd}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00323         \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00324         \hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{,}
00325                 deltaTime\hyperlink{particle_system_8cuh_ad9d704d76ddff93e75ca7d39f57bbced}{)};
00326 
00327     \textcolor{comment}{// note: do unmap at end here to avoid unnecessary graphics/CUDA context switch}
00328     \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00329     \{
00330         \hyperlink{particle_system_8cuh_a98c3325419b7528d34a51ca7972d7095}{unmapGLBufferObject}\hyperlink{particle_system_8cuh_a98c3325419b7528d34a51ca7972d7095}{(}\hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}
      \hyperlink{particle_system_8cuh_a98c3325419b7528d34a51ca7972d7095}{)};
00331     \}
00332 \}
00333 
00334 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00335}{}\hyperlink{class_particle_system_a722bdb7cc940f052400a69fe9569a49e}{00335} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a722bdb7cc940f052400a69fe9569a49e}{dumpGrid}()
00336 \{
00337     \textcolor{comment}{// dump grid information}
00338     \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{copyArrayFromDevice}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{(}\hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 
      \hyperlink{class_particle_system_a137909a8b34f7a42e50cd0fcc86bb784}{m\_dCellStart}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 0\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})*\hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{)};
00339     \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{copyArrayFromDevice}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{(}\hyperlink{class_particle_system_a8d8ad2d142f3a5b83f2c10a46f5d7a8b}{m\_hCellEnd}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 
      \hyperlink{class_particle_system_a3a0b9c760c2bfcf811d54b8194ebea01}{m\_dCellEnd}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 0\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \textcolor{keyword}{sizeof}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint})*\hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{)};
00340     \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} maxCellSize = 0;
00341 
00342     \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} i=0; i<\hyperlink{class_particle_system_aa1ef17d723af5d7a4685e8fd57e9ca89}{m\_numGridCells}; i++)
00343     \{
00344         \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart}[i] != 0xffffffff)
00345         \{
00346             \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} cellSize = \hyperlink{class_particle_system_a8d8ad2d142f3a5b83f2c10a46f5d7a8b}{m\_hCellEnd}[i] - \hyperlink{class_particle_system_a8412ecd991c14d906fcebba42bdeffd3}{m\_hCellStart}[i];
00347 
00348             \textcolor{comment}{//            printf("cell: %d, %d particles\(\backslash\)n", i, cellSize);}
00349             \textcolor{keywordflow}{if} (cellSize > maxCellSize)
00350             \{
00351                 maxCellSize = cellSize;
00352             \}
00353         \}
00354     \}
00355 
00356     printf(\textcolor{stringliteral}{"maximum particles per cell = %d\(\backslash\)n"}, maxCellSize);
00357 \}
00358 
00359 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00360}{}\hyperlink{class_particle_system_a9025f319e07c58c6ece1cd2a620ce33a}{00360} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a9025f319e07c58c6ece1cd2a620ce33a}{dumpParticles}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} start, 
      \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} count)
00361 \{
00362     \textcolor{comment}{// debug}
00363     \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{copyArrayFromDevice}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{(}\hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 0\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} &
      \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})*4*count\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{)};
00364     \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{copyArrayFromDevice}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{(}\hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} 0
      \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})*4*count\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{)};
00365 
00366     \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} i=start; i<start+count; i++)
00367     \{
00368         \textcolor{comment}{//        printf("%d: ", i);}
00369         printf(\textcolor{stringliteral}{"pos: (%.4f, %.4f, %.4f, %.4f)\(\backslash\)n"}, \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[i*4+0], 
      \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[i*4+1], \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[i*4+2], \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[i*4+3]);
00370         printf(\textcolor{stringliteral}{"vel: (%.4f, %.4f, %.4f, %.4f)\(\backslash\)n"}, \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+0], 
      \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+1], \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+2], \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+3]);
00371     \}
00372 \}
00373 
00374 \textcolor{keywordtype}{float} *
\hypertarget{particle_system_8cpp_source_l00375}{}\hyperlink{class_particle_system_a8bdfaa6198651ef0ceb8be489ecd78e3}{00375} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a8bdfaa6198651ef0ceb8be489ecd78e3}{getArray}(\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3}{ParticleArray} array)
00376 \{
00377     assert(\hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized});
00378 
00379     \textcolor{keywordtype}{float} *hdata = 0;
00380     \textcolor{keywordtype}{float} *ddata = 0;
00381     \textcolor{keyword}{struct} cudaGraphicsResource *cuda\_vbo\_resource = 0;
00382 
00383     \textcolor{keywordflow}{switch} (array)
00384     \{
00385         \textcolor{keywordflow}{default}:
00386         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a9e9a2992d230a2674debf26e0e8e0299}{POSITION}:
00387             hdata = \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos};
00388             ddata = \hyperlink{class_particle_system_afff6217d2726217dff77c81ef3c23bfa}{m\_dPos};
00389             cuda\_vbo\_resource = \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource};
00390             \textcolor{keywordflow}{break};
00391 
00392         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a3702de73065f01b4f6ffa604b799e53d}{VELOCITY}:
00393             hdata = \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel};
00394             ddata = \hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel};
00395             \textcolor{keywordflow}{break};
00396     \}
00397 
00398     \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{copyArrayFromDevice}\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{(}hdata\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} ddata\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} &cuda\_vbo\_resource
      \hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})\hyperlink{particle_system_8cuh_a54716407dbd516db34f42b2faf7f91a3}{)};
00399     \textcolor{keywordflow}{return} hdata;
00400 \}
00401 
00402 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00403}{}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{00403} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{setArray}(\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3}{ParticleArray} array, \textcolor{keyword}{const} \textcolor{keywordtype}{float} *
      data, \textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} count)
00404 \{
00405     assert(\hyperlink{class_particle_system_a21bbfba9d8701a70bc6fddbf4fc3f5bd}{m\_bInitialized});
00406 
00407     \textcolor{keywordflow}{switch} (array)
00408     \{
00409         \textcolor{keywordflow}{default}:
00410         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a9e9a2992d230a2674debf26e0e8e0299}{POSITION}:
00411             \{
00412                 \textcolor{keywordflow}{if} (\hyperlink{class_particle_system_a5d99413ffc0791e6aa9f02308caf7f1e}{m\_bUseOpenGL})
00413                 \{
00414                     \hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{unregisterGLBufferObject}\hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{(}
      \hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_a9afef8c00ca779aae2d7484b45bce34c}{)};
00415                     glBindBuffer(GL\_ARRAY\_BUFFER, m\_posVbo);
00416                     glBufferSubData(GL\_ARRAY\_BUFFER, start*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}), count*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float}), 
      data);
00417                     glBindBuffer(GL\_ARRAY\_BUFFER, 0);
00418                     \hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{registerGLBufferObject}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{(}\hyperlink{class_particle_system_a31f9cccdf5dbae6f72867665bd8761e3}{m\_posVbo}
      \hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{,} &\hyperlink{class_particle_system_a9c5de70c1705672e5722ad30dee1b14b}{m\_cuda\_posvbo\_resource}\hyperlink{particle_system_8cuh_a4386a84282ceeaba09939817aa2a9c24}{)};
00419                 \}
00420             \}
00421             \textcolor{keywordflow}{break};
00422 
00423         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a3702de73065f01b4f6ffa604b799e53d}{VELOCITY}:
00424             \hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{copyArrayToDevice}\hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{(}\hyperlink{class_particle_system_a5efd31a2fdba8d98b105f4e546964cb5}{m\_dVel}\hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{,} data\hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{,} start*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})
      \hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{,} count*4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})\hyperlink{particle_system_8cuh_ac4d4ecd921dbed6c2deef639ca295374}{)};
00425             \textcolor{keywordflow}{break};
00426     \}
00427 \}
00428 
\hypertarget{particle_system_8cpp_source_l00429}{}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{00429} \textcolor{keyword}{inline} \textcolor{keywordtype}{float} \hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{frand}()
00430 \{
00431     \textcolor{keywordflow}{return} rand() / (\textcolor{keywordtype}{float}) RAND\_MAX;
00432 \}
00433 
00434 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00435}{}\hyperlink{class_particle_system_a2e08c4e354b0de5e2dc468a0fb457dfe}{00435} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a2e08c4e354b0de5e2dc468a0fb457dfe}{initGrid}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} *size, \textcolor{keywordtype}{float} spacing, \textcolor{keywordtype}{float} jitter, 
      \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} numParticles)
00436 \{
00437     srand(1973);
00438 
00439     \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} z=0; z<size[2]; z++)
00440     \{
00441         \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} y=0; y<size[1]; y++)
00442         \{
00443             \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} x=0; x<size[0]; x++)
00444             \{
00445                 \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} i = (z*size[1]*size[0]) + (y*size[0]) + x;
00446 
00447                 \textcolor{keywordflow}{if} (i < numParticles)
00448                 \{
00449                     m\_hPos[i*4] = (spacing * x) + m\_params.particleRadius - 1.0f + (frand()*2.0f-1.0f)
      *jitter;
00450                     m\_hPos[i*4+1] = (spacing * y) + m\_params.particleRadius - 1.0f + (frand()*2.0f-
      1.0f)*jitter;
00451                     m\_hPos[i*4+2] = (spacing * z) + m\_params.particleRadius - 1.0f + (frand()*2.0f-
      1.0f)*jitter;
00452                     \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[i*4+3] = 1.0f;
00453 
00454                     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4] = 0.0f;
00455                     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+1] = 0.0f;
00456                     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+2] = 0.0f;
00457                     \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[i*4+3] = 0.0f;
00458                 \}
00459             \}
00460         \}
00461     \}
00462 \}
00463 
00464 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00465}{}\hyperlink{class_particle_system_a519070812dd9eb349f270c793c5f64b6}{00465} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_a519070812dd9eb349f270c793c5f64b6}{reset}(\hyperlink{class_particle_system_a1dca3996c8068602412ef9f7826605d1}{ParticleConfig} config)
00466 \{
00467     \textcolor{keywordflow}{switch} (config)
00468     \{
00469         \textcolor{keywordflow}{default}:
00470         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a1dca3996c8068602412ef9f7826605d1a053c69e4e6b094605ea152a644e7c9ee}{CONFIG\_RANDOM}:
00471             \{
00472                 \textcolor{keywordtype}{int} p = 0, v = 0;
00473                                 \textcolor{keywordtype}{float} tmpbrad=m\_params.bigradius-m\_params.particleRadius;
00474                                 \textcolor{keywordtype}{float} tmprad=tmpbrad/2;
00475                                 \textcolor{comment}{//printf("%f\(\backslash\)n",tmprad);}
00476                                 \textcolor{keywordtype}{bool} bo1=\textcolor{keyword}{false};
00477 
00478                 \textcolor{keywordflow}{for} (\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} i=0; i < \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}; \textcolor{comment}{/*i++*/})
00479                 \{
00480                     \textcolor{keywordtype}{float} point[3];
00481                     \textcolor{comment}{//point[0] = frand();}
00482                     \textcolor{comment}{//point[1] = frand();}
00483                     \textcolor{comment}{//point[2] = frand();}
00484                                         \textcolor{comment}{/*point[0]=tmpbrad*frand()-tmprad;//frand -> (0.0f,1.0f) 1.0f
       - promien kuli}
00485 \textcolor{comment}{                                        float my=sqrt(tmprad*tmprad-point[0]*point[0]);}
00486 \textcolor{comment}{                                        point[1]=rand() /( float ) RAND\_MAX *( 2*my ) - my;}
00487 \textcolor{comment}{                                        float
       mz=sqrt(tmprad*tmprad-point[0]*point[0]-point[1]*point[1]);}
00488 \textcolor{comment}{                                        point[2]=rand() /( float ) RAND\_MAX *( 2*mz ) - mz;*/}
00489 
00490                                         point[0]=tmpbrad*\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{frand}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{(}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{)}-tmprad;
00491                                         point[1]=tmpbrad*\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{frand}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{(}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{)}-tmprad;
00492                                         point[2]=tmpbrad*\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{frand}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{(}\hyperlink{particle_system_8cpp_a5459f6b6b39f9a6b80de7f17c3777ee2}{)}-tmprad;
00493                     \textcolor{comment}{/** \(\backslash\)brief r√≥wnomierne losowanie po≈Ço≈ºe≈Ñ metodƒÖ Monte Carlo}
00494 \textcolor{comment}{                     * \(\backslash\)param point[0]*point[0]+point[1]*point[1]+point[2]*point[2]<=tmpbrad*tmpbrad
       x^2+y^2+z^2<=R^2}
00495 \textcolor{comment}{                     */}
00496                                         \textcolor{keywordflow}{if}((point[0]*point[0]+point[1]*point[1]+point[2]*point[2])<(
      tmprad*tmprad))
00497                     \{
00498                         bo1=\textcolor{keyword}{true};
00499                         \textcolor{keywordflow}{for}(\hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} j=0;j<\hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles} && j<i;j++)
00500                         \{
00501                                                         \textcolor{keywordtype}{int} j4=4*j;
00502                             \textcolor{keywordflow}{if}( ( (m\_hPos[j4]-point[0]*2)*(m\_hPos[j4]-point[0]*2)+(m\_hPos[j4+1]-point[
      1]*2)*(m\_hPos[j4+1]-point[1]*2)+(m\_hPos[j4+2]-point[2]*2)*(m\_hPos[j4+2]-point[2]*2) )<4.0f*m\_params.
      particleRadius*m\_params.particleRadius)
00503                             \{
00504                                                                 \textcolor{comment}{//printf("%d %d %f %f %f\(\backslash\)n",i ,j
       ,point[0],point[1],point[2]);}
00505                                 bo1=\textcolor{keyword}{false};
00506                                 \textcolor{keywordflow}{break};
00507                             \}
00508                         \}
00509                         \textcolor{keywordflow}{if}(bo1)
00510                                                 \{
00511                         i++;
00512                         \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[p++] = 2 * (point[0] - 0.0f);
00513                         \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[p++] = 2 * (point[1] - 0.0f);
00514                         \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[p++] = 2 * (point[2] - 0.0f);
00515                         \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}[p++] = 1.0f; \textcolor{comment}{// radius}
00516                         \textcolor{comment}{/*m\_hVel[v++] = (rand() /( float ) RAND\_MAX -0.5f)*m\_params.brown;}
00517 \textcolor{comment}{                        m\_hVel[v++] = (rand() /( float ) RAND\_MAX -0.5f)*m\_params.brown;;}
00518 \textcolor{comment}{                        m\_hVel[v++] = (rand() /( float ) RAND\_MAX -0.5f)*m\_params.brown;;*/}
00519                                                 \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[v++] = 0.0f;
00520                                                 \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[v++] = 0.0f;
00521                                                 \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[v++] = 0.0f;
00522                         \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}[v++] = 0.0f;
00523                                                 \}
00524                     \}
00525                 \}
00526                                 \textcolor{comment}{/*for(int i=0;i<m\_numParticles;i++)}
00527 \textcolor{comment}{                                \{}
00528 \textcolor{comment}{                                        printf("i: %d\(\backslash\)n",i);}
00529 \textcolor{comment}{                                        for(int j=0;j<4;j++)}
00530 \textcolor{comment}{                                                printf("%f ",m\_hPos[i*4+j]);}
00531 \textcolor{comment}{                                        printf("\(\backslash\)n");}
00532 \textcolor{comment}{                                \}*/}
00533             \}
00534             \textcolor{keywordflow}{break};
00535 
00536         \textcolor{keywordflow}{case} \hyperlink{class_particle_system_a1dca3996c8068602412ef9f7826605d1aa6bd9e92edfc102877bf103547397b47}{CONFIG\_GRID}:
00537             \{
00538                 \textcolor{keywordtype}{float} jitter = m\_params.particleRadius*0.01f;
00539                 \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} s = (\textcolor{keywordtype}{int}) ceilf(powf((\textcolor{keywordtype}{float}) \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}, 1.0f / 3.0f));
00540                 \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} gridSize[3];
00541                 gridSize[0] = gridSize[1] = gridSize[2] = s;
00542                 initGrid(gridSize, m\_params.particleRadius*2.0f, jitter, m\_numParticles);
00543             \}
00544             \textcolor{keywordflow}{break};
00545     \}
00546 
00547     \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{setArray}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{(}\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a9e9a2992d230a2674debf26e0e8e0299}{POSITION}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} 0\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}
      \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{)};
00548     \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{setArray}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{(}\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a3702de73065f01b4f6ffa604b799e53d}{VELOCITY}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} 0\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_a23d238efa80a647d4b6cde034f486a91}{m\_numParticles}
      \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{)};
00549 \}
00550 
00551 \textcolor{keywordtype}{void}
\hypertarget{particle_system_8cpp_source_l00552}{}\hyperlink{class_particle_system_af2f16676fe8a0523cfb867a9a856970c}{00552} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_af2f16676fe8a0523cfb867a9a856970c}{addSphere}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{float} *pos, \textcolor{keywordtype}{float} *vel, \textcolor{keywordtype}{int} r, \textcolor{keywordtype}{float} 
      spacing)
00553 \{
00554     \hyperlink{particles__kernel_8cuh_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint} index = start;
00555 
00556     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} z=-r; z<=r; z++)
00557     \{
00558         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y=-r; y<=r; y++)
00559         \{
00560             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x=-r; x<=r; x++)
00561             \{
00562                 \textcolor{keywordtype}{float} dx = x*spacing;
00563                 \textcolor{keywordtype}{float} dy = y*spacing;
00564                 \textcolor{keywordtype}{float} dz = z*spacing;
00565                 \textcolor{keywordtype}{float} l = sqrtf(dx*dx + dy*dy + dz*dz);
00566                 \textcolor{keywordtype}{float} jitter = m\_params.particleRadius*0.01f;
00567 
00568                 \textcolor{keywordflow}{if} ((l <= m\_params.particleRadius*2.0f*r) && (index < m\_numParticles))
00569                 \{
00570                     m\_hPos[index*4]   = pos[0] + dx + (frand()*2.0f-1.0f)*jitter;
00571                     m\_hPos[index*4+1] = pos[1] + dy + (frand()*2.0f-1.0f)*jitter;
00572                     m\_hPos[index*4+2] = pos[2] + dz + (frand()*2.0f-1.0f)*jitter;
00573                     m\_hPos[index*4+3] = pos[3];
00574 
00575                     m\_hVel[index*4]   = vel[0];
00576                     m\_hVel[index*4+1] = vel[1];
00577                     m\_hVel[index*4+2] = vel[2];
00578                     m\_hVel[index*4+3] = vel[3];
00579                     index++;
00580                 \}
00581             \}
00582         \}
00583     \}
00584 
00585     \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{setArray}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{(}\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a9e9a2992d230a2674debf26e0e8e0299}{POSITION}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_ab9d75471d2eaaeb8fa98d2f3f47d9c25}{m\_hPos}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} start\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} index\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{)};
00586     \hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{setArray}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{(}\hyperlink{class_particle_system_a332fbe57a36aaea5c18b4ea4fba6bbb3a3702de73065f01b4f6ffa604b799e53d}{VELOCITY}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} \hyperlink{class_particle_system_a20560c896ee8a8bbc827a8e5902da7e2}{m\_hVel}\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} start\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{,} index\hyperlink{class_particle_system_aa792a66680e800832059854aab0d594d}{)};
00587 \}
00588 
\hypertarget{particle_system_8cpp_source_l00589}{}\hyperlink{class_particle_system_1_1particle_type}{00589} \textcolor{keyword}{class} \hyperlink{class_particle_system}{ParticleSystem}::\hyperlink{class_particle_system_1_1particle_type}{particleType}
00590 \{
00591         \textcolor{keyword}{public}:
\hypertarget{particle_system_8cpp_source_l00592}{}\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcf}{00592}                 \textcolor{keyword}{enum} \hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcf}{types}
00593                 \{
\hypertarget{particle_system_8cpp_source_l00594}{}\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfabf31550fb1eca476d61467c6e2f37e4a}{00594}                         \hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfabf31550fb1eca476d61467c6e2f37e4a}{TypeOne}=1,
\hypertarget{particle_system_8cpp_source_l00595}{}\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfa62eb1dd5282cb0f225ab2a1de3df820d}{00595}                         \hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfa62eb1dd5282cb0f225ab2a1de3df820d}{TypeTwo}=2,
\hypertarget{particle_system_8cpp_source_l00596}{}\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfa2a1a0e456096ddefcfd80d6dea0164f5}{00596}                         \hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfa2a1a0e456096ddefcfd80d6dea0164f5}{Default}
00597                 \};
\hypertarget{particle_system_8cpp_source_l00598}{}\hyperlink{class_particle_system_1_1particle_type_aa28b152ee001a7797b9a308291a8c92a}{00598}                 \hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcf}{types} \hyperlink{class_particle_system_1_1particle_type_aa28b152ee001a7797b9a308291a8c92a}{type};
\hypertarget{particle_system_8cpp_source_l00599}{}\hyperlink{class_particle_system_1_1particle_type_a7b31955f076be65f9bd704a23032597c}{00599}                 \textcolor{keywordtype}{float} \hyperlink{class_particle_system_1_1particle_type_a7b31955f076be65f9bd704a23032597c}{mass};
\hypertarget{particle_system_8cpp_source_l00600}{}\hyperlink{class_particle_system_1_1particle_type_a262c51b90d7c71f897584e1584c22a41}{00600}                 \textcolor{keywordtype}{float} \hyperlink{class_particle_system_1_1particle_type_a262c51b90d7c71f897584e1584c22a41}{radius};
\hypertarget{particle_system_8cpp_source_l00601}{}\hyperlink{class_particle_system_1_1particle_type_a12bff78b90f86f1d8b3f26958aef6152}{00601}                 \hyperlink{class_particle_system_1_1particle_type_a12bff78b90f86f1d8b3f26958aef6152}{particleType}(\textcolor{keywordtype}{float} x)
00602                 \{
00603                         \textcolor{keywordflow}{if}(x==1.0f)
00604                         \{
00605                                 \hyperlink{class_particle_system_1_1particle_type_aa28b152ee001a7797b9a308291a8c92a}{type}=\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfabf31550fb1eca476d61467c6e2f37e4a}{TypeOne};
00606                                 \hyperlink{class_particle_system_1_1particle_type_a7b31955f076be65f9bd704a23032597c}{mass}=0.001f;
00607                                 \hyperlink{class_particle_system_1_1particle_type_a262c51b90d7c71f897584e1584c22a41}{radius}=0.225f;
00608                         \}
00609                         \textcolor{keywordflow}{else} \textcolor{comment}{/*if(x==2.0f)*/}
00610                         \{
00611                                 \hyperlink{class_particle_system_1_1particle_type_aa28b152ee001a7797b9a308291a8c92a}{type}=\hyperlink{class_particle_system_1_1particle_type_a41677c7a6376be429aae198a3d6d0dcfa62eb1dd5282cb0f225ab2a1de3df820d}{TypeTwo};
00612                                 \hyperlink{class_particle_system_1_1particle_type_a7b31955f076be65f9bd704a23032597c}{mass}=0.00001f;
00613                                 \hyperlink{class_particle_system_1_1particle_type_a262c51b90d7c71f897584e1584c22a41}{radius}=0.0225f;
00614                         \}
00615                         \textcolor{comment}{/*else}
00616 \textcolor{comment}{                        \{}
00617 \textcolor{comment}{                                type=Default;}
00618 \textcolor{comment}{                        \}*/}
00619                 \};
00620 \};
\end{DoxyCode}
